--====================================================
-- ðŸ“º TITAN TIVI MAN HUB | BLOX FRUITS | RAYFIELD FINAL
--====================================================

-- Load Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "ðŸ“º Titan Tivi Man Hub | FINAL",
    LoadingTitle = "Titan Tivi Man Hub",
    LoadingSubtitle = "Auto Farm â€¢ Dodge â€¢ Raid",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "TitanTiviMan",
        FileName = "Final"
    },
    KeySystem = false
})

-- Services
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VIM = game:GetService("VirtualInputManager")
local LP = Players.LocalPlayer
local CommF = RS.Remotes.CommF_

-- State
local State = {
    AutoFarm = false,
    AutoQuest = true,
    AutoSkill = false,
    AutoDodge = false,
    Aim = false,
    AutoRaid = false,
    AutoAwaken = false
}

-- Utils
local function Char()
    return LP.Character or LP.CharacterAdded:Wait()
end
local function HRP()
    return Char():WaitForChild("HumanoidRootPart")
end

-- Auto Equip Combat (vÃµ)
local function EquipCombat()
    local char = LP.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    for _,tool in pairs(LP.Backpack:GetChildren()) do
        if tool:IsA("Tool") then
            local n = tool.Name:lower()
            if n:find("combat") or n:find("leg") or n:find("electric")
            or n:find("dragon") or n:find("godhuman") or n:find("karate") then
                hum:EquipTool(tool)
                break
            end
        end
    end
end

-- Cháº¿t / respawn -> auto equip vÃµ
LP.CharacterAdded:Connect(function()
    task.wait(1)
    EquipCombat()
end)

-- Giá»¯ vÃµ liÃªn tá»¥c khi Auto Farm báº­t
task.spawn(function()
    while task.wait(1) do
        if State.AutoFarm then
            EquipCombat()
        end
    end
end)

-- Quest check
local function HasQuest()
    local gui = LP.PlayerGui:FindFirstChild("Main")
    return gui and gui:FindFirstChild("Quest") and gui.Quest.Visible
end

-- Auto Quest
task.spawn(function()
    while task.wait(1) do
        if State.AutoFarm and State.AutoQuest and not HasQuest() then
            pcall(function()
                CommF:InvokeServer("StartQuest","BanditQuest1",1)
            end)
        end
    end
end)

-- Target
local function GetBoss()
    for _,v in pairs(workspace.Enemies:GetChildren()) do
        if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0
        and v.Name:lower():find("boss") then
            return v
        end
    end
end

local function GetNPC()
    local best, dist = nil, math.huge
    for _,v in pairs(workspace.Enemies:GetChildren()) do
        if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0
        and v:FindFirstChild("HumanoidRootPart")
        and not v.Name:lower():find("boss") then
            local d = (v.HumanoidRootPart.Position - HRP().Position).Magnitude
            if d < dist then
                dist = d
                best = v
            end
        end
    end
    return best
end

local function GetTarget()
    return GetBoss() or GetNPC()
end

-- Air Farm (Ä‘Ã¡nh trÃªn khÃ´ng)
task.spawn(function()
    while task.wait(0.12) do
        if State.AutoFarm then
            local t = GetTarget()
            if t and t:FindFirstChild("HumanoidRootPart") then
                HRP().AssemblyLinearVelocity = Vector3.zero
                HRP().CFrame =
                    t.HumanoidRootPart.CFrame
                    * CFrame.new(0,25,6)
                    * CFrame.Angles(math.rad(-90),0,0)
            end
        end
    end
end)

-- Auto Skill (NO M1)
local Skills = {
    Enum.KeyCode.Z,
    Enum.KeyCode.X,
    Enum.KeyCode.C,
    Enum.KeyCode.V,
    Enum.KeyCode.F
}
local idx = 1
task.spawn(function()
    while task.wait(0.45) do
        if State.AutoSkill then
            local k = Skills[idx]
            idx = idx % #Skills + 1
            VIM:SendKeyEvent(true, k, false, game)
            task.wait(0.05)
            VIM:SendKeyEvent(false, k, false, game)
        end
    end
end)

-- Aim
RunService.RenderStepped:Connect(function()
    if State.Aim then
        local t = GetTarget()
        if t and t:FindFirstChild("Head") then
            workspace.CurrentCamera.CFrame =
                CFrame.new(workspace.CurrentCamera.CFrame.Position, t.Head.Position)
        end
    end
end)

-- Auto Dodge Sea 1 / 2 / 3
local DodgeCD = false
local LastHP = 0
task.spawn(function()
    while task.wait(0.1) do
        if not State.AutoDodge or not State.AutoFarm then continue end
        local hum = Char():FindFirstChild("Humanoid")
        if not hum then continue end
        if LastHP == 0 then LastHP = hum.Health end

        local drop = LastHP - hum.Health
        LastHP = hum.Health

        local t = GetTarget()
        local need = false
        if drop > hum.MaxHealth * 0.08 then need = true end
        if t and t:FindFirstChild("HumanoidRootPart") then
            if (t.HumanoidRootPart.Position - HRP().Position).Magnitude < 25 then
                need = true
            end
        end

        if need and not DodgeCD then
            DodgeCD = true
            HRP().CFrame =
                HRP().CFrame * CFrame.new(
                    math.random(-30,30),
                    math.random(35,55),
                    math.random(-20,-10)
                )
            task.wait(0.45)
            DodgeCD = false
        end
    end
end)

-- Auto Raid + Awaken
local RaidFruit = "Flame"
local RaidMethod = "Fruit"

task.spawn(function()
    while task.wait(2) do
        if State.AutoRaid then
            pcall(function()
                CommF:InvokeServer("RaidsNpc","Select",RaidFruit)
                CommF:InvokeServer("RaidsNpc","Start",RaidMethod)
            end)
        end
    end
end)

task.spawn(function()
    while task.wait(3) do
        if State.AutoAwaken then
            pcall(function()
                CommF:InvokeServer("Awakener","Awaken")
            end)
        end
    end
end)

-- UI
local StartTab = Window:CreateTab("ðŸš€ Start")
local FarmTab  = Window:CreateTab("âš›ï¸ Farm")
local CombatTab= Window:CreateTab("âš”ï¸ Combat")
local RaidTab  = Window:CreateTab("ðŸ”¥ Raid")

StartTab:CreateButton({
    Name = "START ALL",
    Callback = function()
        for k in pairs(State) do State[k] = true end
        EquipCombat()
        Rayfield:Notify({Title="Titan Hub",Content="ALL ENABLED",Duration=3})
    end
})

StartTab:CreateButton({
    Name = "ðŸ›‘ STOP ALL",
    Callback = function()
        for k in pairs(State) do State[k] = false end
        Rayfield:Notify({Title="Titan Hub",Content="ALL STOPPED",Duration=3})
    end
})

FarmTab:CreateToggle({
    Name = "Auto Farm (Air)",
    CurrentValue = false,
    Callback = function(v)
        State.AutoFarm = v
        if v then
            task.wait(0.2)
            EquipCombat() -- ðŸ”¥ báº­t Auto Farm = báº­t vÃµ
        end
    end
})

CombatTab:CreateToggle({
    Name = "Auto Skill (No M1)",
    CurrentValue = false,
    Callback = function(v) State.AutoSkill = v end
})

CombatTab:CreateToggle({
    Name = "Aim Lock",
    CurrentValue = false,
    Callback = function(v) State.Aim = v end
})

CombatTab:CreateToggle({
    Name = "Auto Dodge (Sea 1 / 2 / 3)",
    CurrentValue = false,
    Callback = function(v) State.AutoDodge = v end
})

RaidTab:CreateToggle({
    Name = "Auto Raid",
    CurrentValue = false,
    Callback = function(v) State.AutoRaid = v end
})

RaidTab:CreateDropdown({
    Name = "Raid Fruit",
    Options = {"Flame","Ice","Light","Magma","Dark","Buddha","Rumble"},
    CurrentOption = "Flame",
    Callback = function(v) RaidFruit = v end
})

RaidTab:CreateDropdown({
    Name = "Raid Method",
    Options = {"Fruit","Money"},
    CurrentOption = "Fruit",
    Callback = function(v) RaidMethod = v end
})

RaidTab:CreateToggle({
    Name = "Auto Awaken",
    CurrentValue = false,
    Callback = function(v) State.AutoAwaken = v end
})

Rayfield:Notify({
    Title = "Titan Tivi Man Hub",
    Content = "Loaded Successfully",
    Duration = 3
})
